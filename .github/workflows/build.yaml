on: [push]

name: Build image & Test

jobs:
  Test-api:
    name: Testing my api
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v3
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install dependencies
        run: cd api && npm install
      - name: Run tests
        run: npm run test test/test.js

    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v3
    #   - name: Run docker-compose
    #     run: docker-compose up -d
    #   - name: Test
    #     run: |
    #       docker-compose exec mat-api npm run test test/test.js
    #   - name: Stop docker-compose
    #     run: docker-compose down

  build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push to GitHub registry
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ghcr.io/fabienlpt/api:latest
          target: api

      - name: Build and push to GitHub registry
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ghcr.io/fabienlpt/app:latest
          target: app

