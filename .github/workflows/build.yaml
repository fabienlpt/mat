on: [push]

name: Build image & Test

jobs:
  test:
    name: Testing my api
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: api
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Install dependencies
        run: npm install
        working-directory: api
      - name: Run tests
        run: npm test test/test.js
        working-directory: api
      - name: Build image
        run: docker build -t my-api .
        working-directory: api
      - name: Run image
        run: docker run -d -p 3001:3001 my-api
        working-directory: api
      - name: Test image
        run: curl http://localhost:3000
        working-directory: api

    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v3
    #   - name: Run docker-compose
    #     run: docker-compose up -d
    #   - name: Test
    #     run: |
    #       docker-compose exec mat-api npm run test test/test.js
    #   - name: Stop docker-compose
    #     run: docker-compose down



  build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push to GitHub registry
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ghcr.io/fabienlpt/api:latest
          target: api

      - name: Build and push to GitHub registry
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ghcr.io/fabienlpt/app:latest
          target: app

